{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}


<head>
	{% block title %}Checkout{% endblock %}
</head>

<body>
	{% block order_summary %}active{% endblock %}

	{% block body %}

		<!-- JS Disabled -->
		<noscript>
			<meta HTTP-EQUIV="REFRESH" content="0; url={% url 'store:order_summary' %}">
		</noscript>

		<script src="https://js.stripe.com/v3/"></script>

		<form method="POST" class="" id="stripe-form">
			{% csrf_token %}

			<div class="center border-l-grey border-round mw-300">
				<h3 align="center">Shipping Form</h3>
				
				{% if user.is_authenticated %}
					<span id="user-exists"></span>
					<label for="id_address_option">Address Option:</label>
					{{shipping_form.address_option|as_crispy_field}}
					
					<div id="shipping-choices">
						<select name="stored_address" id="id_stored_address" class="form-control">
						{% for x, y in stored_address_list.fields.stored_address.choices %}
						    <option value="{{ x }}"{% if form.fields.customer.value == x %} selected{% endif %}>{{ y }}</option>
						{% endfor %}
						</select>
					</div>
				{% endif %}

				<div id="shipping-form">

					{% if shipping_form.non_field_errors %}
					  <div class="alert alert-danger">
					    {% for err in shipping_form.non_field_errors %}
					      <p>{{ err }}</p>
					    {% endfor %}
					  </div>
					{% endif %}

					<label for="id_line1">Line 1</label>
					{{shipping_form.line1|as_crispy_field}}

					<label for="id_line2">Line 2 (optional)</label>
					{{shipping_form.line2|as_crispy_field}}<br>

					<label for="id_city">City</label>
					{{shipping_form.city|as_crispy_field}}

					<label for="id_state">State</label>
					{{shipping_form.state|as_crispy_field}}

					<label for="id_zipcode">Zip Code</label>
					{{shipping_form.zipcode|as_crispy_field}}

					<label for="id_country">Country</label>
					{{shipping_form.country|as_crispy_field}}<br>

					<label for="id_first_name">First Name</label>
					{{shipping_form.first_name|as_crispy_field}}

					<label for="id_last_name">Last Name</label>
					{{shipping_form.last_name|as_crispy_field}}

					<label for="id_email">Email Address</label>
					{{shipping_form.email|as_crispy_field}}
					<p id="email_error" class="text-error"></p><br>
				</div>

			</div>

			<div class="center border-l-grey border-round mw-300 mt-3">
				<h3 class="mt-3" align="center">Billing Form</h3>

				{% if user.is_authenticated %}
					<label for="id_card_option">Card Option:</label>
					{{billing_form.card_option|as_crispy_field}}

					<div id="card-choices">
						<select name="stored_card" id="id_stored_card" class="form-control">
						{% for x, y in stored_card_list.fields.stored_card.choices %}
						    <option value="{{ x }}"{% if form.fields.customer.value == x %} selected{% endif %}>{{ y }}</option>
						{% endfor %}
						</select>
					</div>
				{% endif %}

				<div id="billing-form">

					{% if billing_form.non_field_errors %}
					  <div class="alert alert-danger">
					    {% for err in billing_form.non_field_errors %}
					      <p>{{ err }}</p>
					    {% endfor %}
					  </div>
					{% endif %}

					<label for="id_billing_line1">Line 1</label>
					{{billing_form.billing_line1|as_crispy_field}}

					<label for="id_billing_line2">Line 2 (optional)</label>
					{{billing_form.billing_line2|as_crispy_field}}

					<label for="id_billing_city">City</label>
					{{billing_form.billing_city|as_crispy_field}}

					<label for="id_billing_state">State</label>
					{{billing_form.billing_state|as_crispy_field}}

					<label for="id_billing_zipcode">Zip Code</label>
					{{billing_form.billing_zipcode|as_crispy_field}}

					<label for="id_billing_country">Country</label>
					{{billing_form.billing_country|as_crispy_field}}					

					<label for="id_billing_first_name">First Name</label>
					{{billing_form.billing_first_name|as_crispy_field}}

					<label for="id_billing_last_name">Last Name</label>
					{{billing_form.billing_last_name|as_crispy_field}}

					<label for="id_billing_email">Email Address</label>
					{{billing_form.billing_email|as_crispy_field}}
					<p id="billing_email_error" class="text-error"></p><br>
				</div>
				
		         <!-- Payment Form -->
		        <div id="payment-form">
		          <h3>Payment</h3>
		          <label for="card-element">Credit or debit card</label>
		          <div id="card-element">
		            <!-- A Stripe Element will be inserted here. -->
		          </div>
		           <!-- Used to display form errors -->
		          <div id="card-errors" role="alert"></div>
		        </div>

			</div>
			<center>
		        <button type="submit" class="btn bt-color1 mw-300 mt-3" id="stripeBtn">Submit Payment</button>
		        <div class="loader mt-3 center"></div>
			</center>
		</form>

	{% endblock body %}

	{% block javascript %}
		<!-- Stripe Code -->
		<script type="text/javascript" src="{% static 'store/js/reusable_code/functions.js' %}"></script>
		<script type="text/javascript" src="{% static 'store/js/checkout.js' %}"></script>

		<script>var stripe = Stripe('{{PUB_KEY}}');</script>
		<script type="text/javascript" src="{% static 'store/js/stripe.js' %}"></script>
	{% endblock javascript %}
</body>
